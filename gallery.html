<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Digital Gratitude List — ZackMoritz.cool</title>
<style>
  :root { --bg:#0f1115; --panel:#12161f; --border:#262b36; --text:#e7ecf1; --muted:#9aa6b2; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 14px}
  h1{margin:0 0 6px}
  .small{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  select{background:#1a232f;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:16px}
  .card{position:relative;display:block;border:1px solid var(--border);background:var(--panel);border-radius:12px;overflow:hidden;text-decoration:none;color:var(--text)}
  .thumb{display:block;width:100%;height:140px;object-fit:cover;background:#0b0e13}
  .label{padding:8px 10px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid var(--border)}
  .badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.55);border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:12px}
  /* lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999}
  .lightbox.open{display:flex}
  .viewer{max-width:92vw;max-height:86vh;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .viewer img,.viewer video,audio{display:block;max-width:92vw;max-height:80vh}
  .viewer .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border)}
  .viewer .name{font-size:14px}
  .btn{cursor:pointer;border:1px solid var(--border);background:#1a232f;color:var(--text);border-radius:8px;padding:6px 10px;font-size:13px}
  /* pagination */
  .pager{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:14px}
  .pagebtn{border:1px solid var(--border);background:#12161f;color:var(--text);border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
  .pagebtn[disabled]{opacity:.5;cursor:not-allowed}
  .pagenum{border:1px solid var(--border);background:#12161f;color:var(--text);border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
  .pagenum.active{background:#1a232f}
</style>
</head>
<body>
<div class="wrap">
  <h1>Digital Gratitude List</h1>
  <div class="small">
    Files in <code>/Digital_Gratitude_List</code> <span id="fileCount"></span>.
    Sorted by <strong>Newest</strong> by default.
  </div>

  <div class="controls">
    <label class="small" for="sortSel">Sort:</label>
    <select id="sortSel">
      <option value="new" selected>Newest</option>
      <option value="old">Oldest</option>
      <option value="az">A–Z</option>
      <option value="za">Z–A</option>
    </select>

    <div class="small" style="margin-left:auto">
      Page <span id="pageInfo">1</span>
    </div>
  </div>

  <div id="grid" class="grid"><div class="small">Loading…</div></div>
  <div id="pager" class="pager" aria-label="Pagination"></div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="viewer">
    <div class="head">
      <div class="name" id="lbName">File</div>
      <div style="display:flex;gap:6px">
        <a id="lbOpen" class="btn" href="#" target="_blank" rel="noopener">Open</a>
        <button id="lbClose" class="btn">Close</button>
      </div>
    </div>
    <div id="lbBody" style="padding:0"></div>
  </div>
</div>

<script>
const REPO   = "zackmoritz/zackmoritz-cool";
const BRANCH = "main";
const FOLDER = "Digital_Gratitude_List";
const PAGE_SIZE = 25;

const IMG_EXT   = /\.(png|jpe?g|gif|webp|heic|heif)$/i;
const VIDEO_EXT = /\.(mp4|mov|webm|m4v)$/i;
const AUDIO_EXT = /\.(m4a|mp3|wav|ogg)$/i;
const FILE_OK   = /\.(png|jpe?g|gif|webp|heic|heif|mp4|mov|webm|m4v|m4a|mp3|wav|ogg)$/i;

const grid     = document.getElementById('grid');
const pager    = document.getElementById('pager');
const pageInfo = document.getElementById('pageInfo');
const sortSel  = document.getElementById('sortSel');
const fileCountEl = document.getElementById('fileCount');

const lb   = document.getElementById('lightbox');
const lbBody = document.getElementById('lbBody');
const lbName = document.getElementById('lbName');
const lbOpen = document.getElementById('lbOpen');
const lbClose= document.getElementById('lbClose');

lbClose.onclick = () => { lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); lbBody.innerHTML=''; };
lb.addEventListener('click', e => { if (e.target === lb) lbClose.onclick(); });

let ALL_FILES = [];   // list from GitHub
let VIEW = [];        // sorted list used for paging
let currentPage = 1;
let totalPages  = 1;

function siteHref(name){ return `/${FOLDER}/${encodeURIComponent(name)}`; }
async function headType(url){
  try { const r = await fetch(url, { method:'HEAD' }); return { ok:r.ok, type:r.headers.get('content-type')||'' }; }
  catch { return { ok:false, type:'' }; }
}

function cardHTML(f){
  const site = siteHref(f.name);
  const raw  = f.download_url;
  const isImg   = IMG_EXT.test(f.name);
  const isVideo = VIDEO_EXT.test(f.name);
  const isAudio = AUDIO_EXT.test(f.name);
  const badge = isVideo ? 'Video' : isAudio ? 'Audio' : 'Image';
  const data = `data-site="${site}" data-raw="${raw}" data-name="${encodeURIComponent(f.name)}" data-kind="${badge}"`;
  return `
    <a href="${site}" class="card" ${data}>
      <span class="badge">${badge}</span>
      ${isImg ? `<img class="thumb" loading="lazy" alt="" ${data}>`
              : `<img class="thumb" alt="" ${data} style="object-fit:contain" />`}
      <div class="label" title="${f.name}">${f.name}</div>
    </a>`;
}

function sortFiles(files, mode){
  switch(mode){
    case 'new': return files.slice().sort((a,b)=> (b._commitTime||0) - (a._commitTime||0));
    case 'old': return files.slice().sort((a,b)=> (a._commitTime||0) - (b._commitTime||0));
    case 'za' : return files.slice().sort((a,b)=> b.name.localeCompare(a.name, undefined, {numeric:true}));
    case 'az' : default: return files.slice().sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true}));
  }
}

function renderPage(){
  totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * PAGE_SIZE;
  const slice = VIEW.slice(start, start + PAGE_SIZE);

  grid.innerHTML = slice.map(cardHTML).join('');

  // thumbs + lightbox
  const thumbs = grid.querySelectorAll('img.thumb');
  thumbs.forEach(async img => {
    const site = img.dataset.site, raw = img.dataset.raw, kind = img.dataset.kind;
    if (kind === 'Image') {
      const t = await headType(site);
      img.src = (!t.ok || (t.type||'').includes('text/html')) ? raw : site;
    } else {
      img.style.background = '#0b0e13'; img.style.height = '120px';
      img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300">
           <rect width="100%" height="100%" fill="#0b0e13"/>
           <text x="50%" y="50%" fill="#9aa6b2" font-family="system-ui" font-size="28" text-anchor="middle" dominant-baseline="middle">${img.dataset.kind}</text>
         </svg>`
      );
    }
  });

  grid.querySelectorAll('a.card').forEach(a => {
    a.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = decodeURIComponent(a.dataset.name);
      const site = a.dataset.site;
      const raw  = a.dataset.raw;
      const kind = a.dataset.kind;
      lbName.textContent = name;

      const t = await headType(site);
      const url = (!t.ok || (t.type||'').includes('text/html')) ? raw : site;
      lbOpen.href = url;

      if (kind === 'Image') {
        lbBody.innerHTML = `<img src="${url}" alt="${name}" style="display:block;max-width:92vw;max-height:80vh">`;
      } else if (kind === 'Video') {
        const type = url.endsWith('.mov') ? 'video/quicktime' : 'video/mp4';
        lbBody.innerHTML = `<video controls playsinline preload="metadata" style="max-width:92vw;max-height:80vh"><source src="${url}" type="${type}"></video>`;
      } else {
        lbBody.innerHTML = `<audio controls preload="metadata" style="width:92vw;max-width:800px"><source src="${url}" type="audio/mp4"></audio>`;
      }
      lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
    });
  });

  pageInfo.textContent = `${currentPage} / ${totalPages}`;
  buildPager();
}

function buildPager(){
  pager.innerHTML = "";
  const prev = document.createElement('button');
  prev.className = 'pagebtn';
  prev.textContent = '‹ Prev';
  prev.disabled = currentPage === 1;
  prev.onclick = () => { currentPage--; renderPage(); };
  pager.appendChild(prev);

  const nums = [];
  const maxBtns = 7;
  if (totalPages <= maxBtns) {
    for (let i=1;i<=totalPages;i++) nums.push(i);
  } else {
    const left = Math.max(1, currentPage - 2);
    const right = Math.min(totalPages, currentPage + 2);
    if (left > 1) nums.push(1, '…');
    for (let i=left;i<=right;i++) nums.push(i);
    if (right < totalPages) nums.push('…', totalPages);
  }

  nums.forEach(n => {
    if (n === '…') {
      const span = document.createElement('span');
      span.className = 'small';
      span.textContent = '…';
      pager.appendChild(span);
      return;
    }
    const b = document.createElement('button');
    b.className = 'pagenum' + (n===currentPage ? ' active' : '');
    b.textContent = n;
    b.onclick = () => { currentPage = n; renderPage(); };
    pager.appendChild(b);
  });

  const next = document.createElement('button');
  next.className = 'pagebtn';
  next.textContent = 'Next ›';
  next.disabled = currentPage === totalPages;
  next.onclick = () => { currentPage++; renderPage(); };
  pager.appendChild(next);
}

// commit API
async function fetchLastCommitISO(path, sha){
  const url = `https://api.github.com/repos/${REPO}/commits?path=${encodeURIComponent(path)}&per_page=1&sha=${encodeURIComponent(BRANCH)}`;
  await new Promise(r => setTimeout(r, 150));
  const res = await fetch(url, { headers:{Accept:"application/vnd.github+json"} });
  if (!res.ok) return null;
  const arr = await res.json();
  return arr?.[0]?.commit?.committer?.date || arr?.[0]?.commit?.author?.date || null;
}

async function fetchList(){
  const url = `https://api.github.com/repos/${REPO}/contents/${encodeURIComponent(FOLDER)}?ref=${encodeURIComponent(BRANCH)}`;
  const r = await fetch(url, { headers:{Accept:"application/vnd.github+json"} });
  if(!r.ok) throw new Error(`GitHub API ${r.status}`);
  const items = await r.json();
  return (Array.isArray(items)?items:[]).filter(it => it.type==='file' && FILE_OK.test(it.name));
}

async function init(){
  grid.innerHTML = `<div class="small">Loading…</div>`;
  try{
    ALL_FILES = await fetchList();
    const imageCount = ALL_FILES.filter(it => IMG_EXT.test(it.name)).length;
    if (fileCountEl) fileCountEl.textContent = `(${imageCount} images, ${ALL_FILES.length} items total)`;

    // fetch commit times
    for (const f of ALL_FILES){
      try{
        const iso = await fetchLastCommitISO(`${FOLDER}/${f.name}`, f.sha);
        f._commitTime = iso ? Date.parse(iso) : 0;
      }catch{ f._commitTime = 0; }
    }

    VIEW = sortFiles(ALL_FILES, sortSel.value || 'new');
    currentPage = 1;
    renderPage();

    sortSel.onchange = () => {
      VIEW = sortFiles(ALL_FILES, sortSel.value);
      currentPage = 1;
      renderPage();
    };
  }catch(err){
    grid.innerHTML = `<div class="small">Error: ${err.message}</div>`;
  }
}

init();
</script>
</body>
</html>